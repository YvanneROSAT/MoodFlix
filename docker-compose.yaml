services:
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
      args:
        # Variable à définir dans Coolify UI: https://api-moodflix.votredomaine.com
        - VITE_BACKEND_API_URL=${VITE_BACKEND_API_URL:?Définir l'URL du backend dans Coolify}
    environment:
      # Magic variable Coolify: génère FQDN et proxy vers port 80
      - SERVICE_FQDN_FRONTEND_80
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    environment:
      # Magic variable Coolify: génère FQDN et proxy vers port 7002
      - SERVICE_FQDN_BACKEND_7002
      - NODE_ENV=production
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY}
      - TMDB_API_KEY=${TMDB_API_KEY}
      - FRONTEND_URL=${SERVICE_FQDN_FRONTEND}
      - REDIS_URL=redis://redis:6379
      - REDIS_TTL=${REDIS_TTL:-3600}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:7002/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped

volumes:
  redis-data:
